@model IEnumerable<HLE.FileServer.Models.GroupFile>
@using HLE.FileServer.Helpers
@using HLE.FileServer.Models
@{
    ViewData["Title"] = "Group Details";
    var breadcrumbs = ViewBag.Breadcrumbs as List<(int? Id, string Name)> ?? new List<(int? Id, string Name)>();
    var currentFolderId = ViewBag.CurrentFolderId as int?;
    var group = ViewBag.Group as Group;
    var userMember = ViewBag.UserMember as GroupMember;
    var isOwner = ViewBag.IsOwner as bool? ?? false;
}

<!-- Mobile Breadcrumb -->
<div class="mobile-breadcrumb">
    <a href="@Url.Action("Index", "Groups")" class="mobile-breadcrumb-item">Groups</a>
    <span class="mobile-breadcrumb-separator">/</span>
    @foreach (var crumb in breadcrumbs)
    {
        @if (crumb != breadcrumbs.Last())
        {
            <a href="@Url.Action("Details", "Groups", new { id = group.Id, folderId = crumb.Id })" class="mobile-breadcrumb-item">@crumb.Name</a>
            <span class="mobile-breadcrumb-separator">/</span>
        }
        else
        {
            <span class="mobile-breadcrumb-item active">@crumb.Name</span>
        }
    }
</div>

<!-- Group Header -->
<div class="mobile-card" style="margin-bottom: 16px;">
    <div style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px;">
        <div class="mobile-group-avatar" style="width: 48px; height: 48px;">@(group.Name.FirstOrDefault())</div>
        <div style="flex: 1;">
            <h2 style="font-size: 1.125rem; font-weight: 600; margin: 0;">@group.Name</h2>
            @{
                var roleText = isOwner ? "Owner" : userMember?.Role.ToString() ?? "Member";
                var roleColor = isOwner ? "var(--primary)" : userMember?.Role == GroupRole.Admin ? "#f59e0b" : "var(--muted-foreground)";
            }
            <span class="badge" style="background: @roleColor; color: white; font-size: 0.6875rem; margin-top: 4px;">@roleText</span>
        </div>
    </div>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.8125rem;">
        <div>
            <span style="color: var(--muted-foreground);">Members</span>
            <strong style="display: block;">@group.Members.Count</strong>
        </div>
        <div>
            <span style="color: var(--muted-foreground);">Storage</span>
            <strong style="display: block;">@FormatFileSize(group.StorageUsedBytes)</strong>
        </div>
    </div>
</div>

<!-- Action Bar -->
<div class="mobile-action-bar">
    @if (isOwner || userMember?.CanManageMembers == true)
    {
        <button type="button" class="mobile-btn mobile-btn-secondary mobile-btn-sm" data-bs-toggle="modal" data-bs-target="#membersModal" onclick="loadMembers()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            Members
        </button>
    }
    @if (isOwner || userMember?.CanUpload == true)
    {
        <button type="button" class="mobile-btn mobile-btn-secondary mobile-btn-sm" data-bs-toggle="modal" data-bs-target="#newFolderModal">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
                <line x1="12" y1="11" x2="12" y2="17"></line>
                <line x1="9" y1="14" x2="15" y2="14"></line>
            </svg>
            Folder
        </button>
        <button type="button" class="mobile-btn mobile-btn-primary mobile-btn-sm" onclick="document.getElementById('fileInput').click()">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            Upload
        </button>
    }
</div>

<!-- Alerts -->
@if (TempData["Success"] != null) { <div class="mobile-alert mobile-alert-success">@TempData["Success"]</div> }
@if (TempData["Error"] != null) { <div class="mobile-alert mobile-alert-error">@TempData["Error"]</div> }
@if (TempData["Warning"] != null) { <div class="mobile-alert mobile-alert-warning">@TempData["Warning"]</div> }

<!-- Upload Form (hidden) -->
@if (isOwner || userMember?.CanUpload == true)
{
    <form id="uploadForm" asp-action="Upload" asp-controller="Groups" method="post" enctype="multipart/form-data" style="display: none;" data-upload-url="/Groups/UploadFile">
        <input type="file" id="fileInput" name="files" multiple />
        <input type="hidden" name="groupId" value="@group.Id" />
        <input type="hidden" name="currentFolderId" value="@currentFolderId" />
        @Html.AntiForgeryToken()
    </form>
}

<!-- Files List -->
@if (Model != null && Model.Any())
{
    <div class="mobile-section-header" style="margin-top: 16px;">
        <h2 class="mobile-section-title">@Model.Count() items</h2>
    </div>

    @foreach (var entry in Model)
    {
        <div class="mobile-file-card" @(entry.IsFolder ? $"onclick=\"window.location.href='{Url.Action("Details", "Groups", new { id = group.Id, folderId = entry.Id })}'\"" : "")>
            <div class="mobile-file-icon @(entry.IsFolder ? "folder" : "file")">
                <span style="font-size: 22px;">@(entry.IsFolder ? "üìÅ" : GetFileIcon(entry.ContentType))</span>
            </div>
            <div class="mobile-file-info">
                <div class="mobile-file-name">@entry.FileName</div>
                <div class="mobile-file-meta">
                    @if (!entry.IsFolder) { <span>@FormatFileSize(entry.FileSize)</span> }
                    <span>@(entry.UploadedBy?.Email ?? "Unknown")</span>
                </div>
            </div>
            <div class="mobile-file-actions" onclick="event.stopPropagation();">
                <button type="button" class="mobile-file-action-btn" data-bs-toggle="dropdown">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="1"></circle>
                        <circle cx="12" cy="5" r="1"></circle>
                        <circle cx="12" cy="19" r="1"></circle>
                    </svg>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    @if (!entry.IsFolder && (isOwner || userMember?.CanDownload == true))
                    {
                        <li><a class="dropdown-item" href="@Url.Action("Download", "Groups", new { id = entry.Id })">Download</a></li>
                    }
                    @if (isOwner || userMember?.CanDelete == true)
                    {
                        <li>
                            <form asp-action="DeleteFile" asp-route-id="@entry.Id" method="post" onsubmit="return confirm('Delete this @(entry.IsFolder ? "folder" : "file")?');">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="dropdown-item text-danger">Delete</button>
                            </form>
                        </li>
                    }
                </ul>
            </div>
        </div>
    }
}
else
{
    <div class="mobile-empty-state">
        <svg class="mobile-empty-icon" xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
        </svg>
        <h3 class="mobile-empty-title">Empty Folder</h3>
        <p class="mobile-empty-description">@((isOwner || userMember?.CanUpload == true) ? "Upload files or create folders to get started!" : "No files have been added yet.")</p>
    </div>
}

<!-- New Folder Modal -->
<div class="modal fade" id="newFolderModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form asp-action="CreateFolder" asp-controller="Groups" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">New Folder</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mobile-form-group">
                        <label class="mobile-form-label">Folder Name</label>
                        <input type="text" class="mobile-form-input" name="folderName" required autofocus>
                    </div>
                    <input type="hidden" name="groupId" value="@group.Id" />
                    <input type="hidden" name="parentFolderId" value="@currentFolderId" />
                    @Html.AntiForgeryToken()
                </div>
                <div class="modal-footer">
                    <button type="button" class="mobile-btn mobile-btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="mobile-btn mobile-btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Members Modal -->
<div class="modal fade" id="membersModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Group Members</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="membersListContainer">
                <div class="text-center py-4">
                    <p class="text-muted">Loading...</p>
                </div>
            </div>
        </div>
    </div>
</div>

@functions {
    string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1) { order++; len /= 1024; }
        return $"{len:0.##} {sizes[order]}";
    }

    string GetFileIcon(string contentType)
    {
        if (contentType.StartsWith("image/")) return "üñºÔ∏è";
        if (contentType.StartsWith("video/")) return "üé•";
        if (contentType.StartsWith("audio/")) return "üéµ";
        if (contentType.Contains("pdf")) return "üìÑ";
        return "üìÅ";
    }
}

<style>
    .modal-content { background: var(--card); color: var(--foreground); border-color: var(--border); }
    .modal-header, .modal-footer { border-color: var(--border); }
    .dropdown-menu { background: var(--card); border-color: var(--border); }
    .dropdown-item { color: var(--foreground); padding: 10px 16px; }
    .dropdown-item:hover { background: var(--accent); }
</style>

@section Scripts {
    <script src="~/js/file-upload.js" asp-append-version="true"></script>
    <script>
        const groupId = @group.Id;
        async function loadMembers() {
            try {
                const response = await fetch(`/Groups/GetMembers/${groupId}`);
                const members = await response.json();
                const container = document.getElementById('membersListContainer');
                if (members.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">No members</p>';
                    return;
                }
                container.innerHTML = members.map(m => `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border);">
                        <div style="width: 40px; height: 40px; border-radius: var(--radius); background: var(--accent); display: flex; align-items: center; justify-content: center; font-weight: 600;">${(m.fullName || 'U')[0]}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 500;">${m.fullName}</div>
                            <div style="font-size: 0.8125rem; color: var(--muted-foreground);">${m.role}</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                document.getElementById('membersListContainer').innerHTML = '<p class="text-danger">Failed to load</p>';
            }
        }
    </script>
}
