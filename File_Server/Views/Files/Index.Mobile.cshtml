@model IEnumerable<HLE.FileServer.Models.FileEntry>
@using System.IO
@using System.Text.Json
@using System.Web
@using HLE.FileServer.Helpers
@{
    ViewData["Title"] = "My Files";
    var breadcrumbs = ViewBag.Breadcrumbs as List<(int? Id, string Name)> ?? new List<(int? Id, string Name)>();
    var currentFolderId = ViewBag.CurrentFolderId as int?;

    string JsEncode(string value) => JsonSerializer.Serialize(value);
}

<!-- Mobile Breadcrumb -->
@if (breadcrumbs.Count > 1)
{
    <div class="mobile-breadcrumb">
        @foreach (var crumb in breadcrumbs)
        {
            @if (crumb != breadcrumbs.Last())
            {
                <a href="@Url.Action("Index", "Files", new { folderId = crumb.Id })" class="mobile-breadcrumb-item">@crumb.Name</a>
                <span class="mobile-breadcrumb-separator">/</span>
            }
            else
            {
                <span class="mobile-breadcrumb-item active">@crumb.Name</span>
            }
        }
    </div>
}

<!-- Page Header -->
<div class="mobile-page-header">
    <h1 class="mobile-page-title">@(breadcrumbs.LastOrDefault().Name ?? "My Files")</h1>
</div>

<!-- Action Bar -->
<div class="mobile-action-bar">
    <button type="button" class="mobile-btn mobile-btn-secondary mobile-btn-sm" data-bs-toggle="modal" data-bs-target="#newFolderModal">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            <line x1="12" y1="11" x2="12" y2="17"></line>
            <line x1="9" y1="14" x2="15" y2="14"></line>
        </svg>
        New Folder
    </button>
    <button type="button" class="mobile-btn mobile-btn-primary mobile-btn-sm" onclick="document.getElementById('fileInput').click()">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
        </svg>
        Upload
    </button>
</div>

<!-- Alerts -->
@if (TempData["Success"] != null)
{
    <div class="mobile-alert mobile-alert-success">@TempData["Success"]</div>
}

@if (TempData["Error"] != null)
{
    <div class="mobile-alert mobile-alert-error">@TempData["Error"]</div>
}

<!-- Upload Zone -->
<div class="mobile-upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
    <svg class="mobile-upload-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
        <polyline points="17 8 12 3 7 8"></polyline>
        <line x1="12" y1="3" x2="12" y2="15"></line>
    </svg>
    <p class="mobile-upload-text">Tap to upload files</p>
    <p class="mobile-upload-hint">Or drag & drop</p>
</div>

<form id="uploadForm" asp-action="Upload" asp-controller="Files" method="post" enctype="multipart/form-data" style="display: none;">
    <input type="file" id="fileInput" name="files" multiple />
    <input type="hidden" name="currentFolderId" value="@currentFolderId" />
    @Html.AntiForgeryToken()
</form>

<!-- Files List -->
@if (Model != null && Model.Any())
{
    <div class="mobile-section-header" style="margin-top: 20px;">
        <h2 class="mobile-section-title">@Model.Count() items</h2>
    </div>

    @foreach (var entry in Model)
    {
        <div class="mobile-file-card" @(entry.IsFolder ? $"onclick=\"window.location.href='{Url.Action("Index", "Files", new { folderId = entry.Id })}'\"" : "")>
            <div class="mobile-file-icon @(entry.IsFolder ? "folder" : "file")">
                @if (entry.IsFolder)
                {
                    <span style="font-size: 22px;">üìÅ</span>
                }
                else
                {
                    <span style="font-size: 22px;">@GetFileIcon(entry.ContentType)</span>
                }
            </div>
            <div class="mobile-file-info">
                <div class="mobile-file-name">@entry.FileName</div>
                <div class="mobile-file-meta">
                    @if (entry.IsFolder)
                    {
                        <span>Folder</span>
                    }
                    else
                    {
                        <span>@FormatFileSize(entry.FileSize)</span>
                        <span>@GetFileExtension(entry.FileName)</span>
                    }
                    <span>@entry.UploadDate.ToLocalTime().ToString("MMM dd")</span>
                </div>
            </div>
            <div class="mobile-file-actions" onclick="event.stopPropagation();">
                <button type="button" class="mobile-file-action-btn" data-bs-toggle="dropdown" aria-expanded="false">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="1"></circle>
                        <circle cx="12" cy="5" r="1"></circle>
                        <circle cx="12" cy="19" r="1"></circle>
                    </svg>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    @if (!entry.IsFolder)
                    {
                        <li>
                            <a class="dropdown-item" href="@Url.Action("Download", "Files", new { id = entry.Id })">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                                Download
                            </a>
                        </li>
                    }
                    <li>
                        <button class="dropdown-item" onclick="openRenameModal(@entry.Id, @JsEncode(entry.FileName))">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                            Rename
                        </button>
                    </li>
                    <li>
                        <button class="dropdown-item" onclick="openMoveModal(@entry.Id, @JsEncode(entry.FileName), @(entry.IsFolder ? "true" : "false"))">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                <path d="M5 3l14 9-14 9V3z"></path>
                            </svg>
                            Move
                        </button>
                    </li>
                    <li>
                        <button class="dropdown-item" onclick="openShareModal(@entry.Id, @JsEncode(entry.FileName))">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                <circle cx="18" cy="5" r="3"></circle>
                                <circle cx="6" cy="12" r="3"></circle>
                                <circle cx="18" cy="19" r="3"></circle>
                                <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                                <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                            </svg>
                            Share
                        </button>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <form asp-action="Delete" asp-route-id="@entry.Id" method="post" onsubmit="return confirm('@(entry.IsFolder ? "Delete this folder and all contents?" : "Delete this file?")');">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="dropdown-item text-danger">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                                Delete
                            </button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>
    }
}
else
{
    <div class="mobile-empty-state">
        <svg class="mobile-empty-icon" xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
        </svg>
        <h3 class="mobile-empty-title">This folder is empty</h3>
        <p class="mobile-empty-description">Create a new folder or upload files to get started!</p>
    </div>
}

<!-- New Folder Modal -->
<div class="modal fade" id="newFolderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form asp-action="CreateFolder" asp-controller="Files" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">New Folder</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mobile-form-group">
                        <label class="mobile-form-label" for="folderName">Folder Name</label>
                        <input type="text" class="mobile-form-input" id="folderName" name="folderName" required autofocus>
                    </div>
                    <input type="hidden" name="parentFolderId" value="@currentFolderId" />
                    @Html.AntiForgeryToken()
                </div>
                <div class="modal-footer">
                    <button type="button" class="mobile-btn mobile-btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="mobile-btn mobile-btn-primary">Create</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Rename Modal -->
<div class="modal fade" id="renameModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rename</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mobile-form-group">
                    <label class="mobile-form-label" for="newItemName">New Name</label>
                    <input type="text" class="mobile-form-input" id="newItemName" required>
                </div>
                <div id="renameAlert" class="mobile-alert mobile-alert-error d-none"></div>
                <input type="hidden" id="renameItemId" />
            </div>
            <div class="modal-footer">
                <button type="button" class="mobile-btn mobile-btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="mobile-btn mobile-btn-primary" onclick="submitRename()">Rename</button>
            </div>
        </div>
    </div>
</div>

<!-- Move Modal -->
<div class="modal fade" id="moveModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="moveForm" asp-action="Move" asp-controller="Files" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Move Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Move <strong id="moveItemName"></strong> to:</p>
                    <div class="mobile-form-group">
                        <label class="mobile-form-label" for="destinationFolder">Destination</label>
                        <select class="mobile-form-input" id="destinationFolder" name="destinationFolderId" required>
                            <option value="">Home (Root)</option>
                        </select>
                    </div>
                    <input type="hidden" id="moveItemId" name="id" />
                    @Html.AntiForgeryToken()
                </div>
                <div class="modal-footer">
                    <button type="button" class="mobile-btn mobile-btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="mobile-btn mobile-btn-primary">Move</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <form id="shareForm" asp-action="Share" asp-controller="Shares" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Share</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Share <strong id="shareItemName"></strong> with:</p>
                    <div class="mobile-form-group">
                        <label class="mobile-form-label" for="userSearch">Search User</label>
                        <input type="text" class="mobile-form-input" id="userSearch" placeholder="Type username or email..." autocomplete="off">
                        <div id="userSearchResults" class="list-group mt-2" style="max-height: 150px; overflow-y: auto;"></div>
                    </div>
                    <div class="mobile-form-group">
                        <label class="mobile-form-label" for="sharePermission">Permission</label>
                        <select class="mobile-form-input" id="sharePermission" name="permission" required>
                            <option value="0">View Only</option>
                            <option value="1">View & Upload</option>
                            <option value="2">Full Edit</option>
                        </select>
                    </div>
                    <input type="hidden" id="shareItemId" name="fileEntryId" />
                    <input type="hidden" id="shareWithUserId" name="sharedWithUserId" />
                    <div id="shareAlert" class="mobile-alert mobile-alert-error d-none"></div>
                    @Html.AntiForgeryToken()
                </div>
                <div class="modal-footer">
                    <button type="button" class="mobile-btn mobile-btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="mobile-btn mobile-btn-primary" id="shareSubmitBtn" disabled>Share</button>
                </div>
            </form>
        </div>
    </div>
</div>

@functions {
    string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB", "TB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    string GetFileExtension(string fileName)
    {
        var ext = System.IO.Path.GetExtension(fileName);
        return string.IsNullOrEmpty(ext) ? "file" : ext.TrimStart('.').ToUpper();
    }

    string GetFileIcon(string contentType)
    {
        if (contentType.StartsWith("image/")) return "üñºÔ∏è";
        if (contentType.StartsWith("video/")) return "üé•";
        if (contentType.StartsWith("audio/")) return "üéµ";
        if (contentType.Contains("pdf")) return "üìÑ";
        if (contentType.Contains("word") || contentType.Contains("document")) return "üìù";
        if (contentType.Contains("excel") || contentType.Contains("spreadsheet")) return "üìä";
        if (contentType.Contains("powerpoint") || contentType.Contains("presentation")) return "üìΩÔ∏è";
        if (contentType.Contains("zip") || contentType.Contains("rar") || contentType.Contains("compressed")) return "üì¶";
        if (contentType.Contains("text")) return "üìÉ";
        return "üìÅ";
    }
}

<style>
    .modal-content {
        background: var(--card);
        color: var(--foreground);
        border-color: var(--border);
    }

    .modal-header, .modal-footer {
        border-color: var(--border);
    }

    .dropdown-menu {
        background: var(--card);
        border-color: var(--border);
    }

    .dropdown-item {
        color: var(--foreground);
        padding: 10px 16px;
    }

    .dropdown-item:hover, .dropdown-item:focus {
        background: var(--accent);
        color: var(--foreground);
    }

    .dropdown-divider {
        border-color: var(--border);
    }

    .list-group-item {
        background: var(--card);
        border-color: var(--border);
        color: var(--foreground);
    }

    .list-group-item:hover {
        background: var(--accent);
    }
</style>

@section Scripts {
    <script src="~/js/file-upload.js" asp-append-version="true"></script>
    <script>
        let moveModal;
        let renameModal;
        let shareModal;
        let allFolders = [];
        let searchTimeout;

        document.addEventListener('DOMContentLoaded', function() {
            moveModal = new bootstrap.Modal(document.getElementById('moveModal'));
            renameModal = new bootstrap.Modal(document.getElementById('renameModal'));
            shareModal = new bootstrap.Modal(document.getElementById('shareModal'));

            document.getElementById('userSearch').addEventListener('input', handleUserSearch);
        });

        function openRenameModal(itemId, currentName) {
            document.getElementById('renameItemId').value = itemId;
            document.getElementById('newItemName').value = currentName;
            document.getElementById('renameAlert').classList.add('d-none');
            renameModal.show();
            setTimeout(() => {
                const input = document.getElementById('newItemName');
                input.focus();
                input.select();
            }, 500);
        }

        async function submitRename() {
            const itemId = document.getElementById('renameItemId').value;
            const newName = document.getElementById('newItemName').value.trim();

            if (!newName) {
                showRenameAlert('Name cannot be empty.');
                return;
            }

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const response = await fetch('/Files/Rename', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `id=${itemId}&newName=${encodeURIComponent(newName)}&__RequestVerificationToken=${encodeURIComponent(token)}`
                });
                const result = await response.json();
                if (result.success) {
                    renameModal.hide();
                    location.reload();
                } else {
                    showRenameAlert(result.message);
                }
            } catch (error) {
                showRenameAlert('Failed to rename. Please try again.');
            }
        }

        function showRenameAlert(message) {
            const alertDiv = document.getElementById('renameAlert');
            alertDiv.textContent = message;
            alertDiv.classList.remove('d-none');
        }

        async function openMoveModal(itemId, itemName, isFolder) {
            document.getElementById('moveItemId').value = itemId;
            document.getElementById('moveItemName').textContent = itemName;

            try {
                const excludeId = isFolder ? itemId : null;
                const response = await fetch(`/Files/GetFolderTree?excludeFolderId=${excludeId || ''}`);
                allFolders = await response.json();

                const select = document.getElementById('destinationFolder');
                select.innerHTML = '<option value="">Home (Root)</option>';

                const rootFolders = allFolders.filter(f => f.parentFolderId === null);
                rootFolders.forEach(folder => addFolderOption(select, folder, 0));

                moveModal.show();
            } catch (error) {
                alert('Failed to load folder list.');
            }
        }

        function addFolderOption(select, folder, level) {
            const option = document.createElement('option');
            option.value = folder.id;
            option.textContent = '\u00A0\u00A0\u00A0'.repeat(level) + 'üìÅ ' + folder.fileName;
            select.appendChild(option);

            allFolders.filter(f => f.parentFolderId === folder.id).forEach(child => {
                addFolderOption(select, child, level + 1);
            });
        }

        function openShareModal(itemId, itemName) {
            document.getElementById('shareItemId').value = itemId;
            document.getElementById('shareItemName').textContent = itemName;
            document.getElementById('userSearch').value = '';
            document.getElementById('userSearchResults').innerHTML = '';
            document.getElementById('shareWithUserId').value = '';
            document.getElementById('shareSubmitBtn').disabled = true;
            document.getElementById('shareAlert').classList.add('d-none');
            shareModal.show();
        }

        function handleUserSearch(event) {
            const query = event.target.value.trim();
            clearTimeout(searchTimeout);

            if (query.length < 2) {
                document.getElementById('userSearchResults').innerHTML = '';
                return;
            }

            searchTimeout = setTimeout(async () => {
                try {
                    const response = await fetch(`/Shares/GetUsers?query=${encodeURIComponent(query)}`);
                    const users = await response.json();
                    displayUserResults(users);
                } catch (error) {
                    console.error('Error searching users:', error);
                }
            }, 300);
        }

        function displayUserResults(users) {
            const resultsDiv = document.getElementById('userSearchResults');
            if (users.length === 0) {
                resultsDiv.innerHTML = '<div class="list-group-item text-muted">No users found</div>';
                return;
            }

            resultsDiv.innerHTML = users.map(user => `
                <a href="#" class="list-group-item list-group-item-action" onclick="selectUser('${user.id}', '${escapeHtml(user.fullName || user.userName)}'); return false;">
                    <div class="fw-bold">${escapeHtml(user.fullName)}</div>
                    <small class="text-muted">${escapeHtml(user.email)}</small>
                </a>
            `).join('');
        }

        function selectUser(userId, displayName) {
            document.getElementById('shareWithUserId').value = userId;
            document.getElementById('userSearch').value = displayName;
            document.getElementById('userSearchResults').innerHTML = '';
            document.getElementById('shareSubmitBtn').disabled = false;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
}
