@using HLE.FileServer.Models
@using HLE.FileServer.Helpers
@{
    ViewData["Title"] = "Shared Files";
    var sharedWithMe = ViewBag.SharedWithMe as List<FileShare> ?? new List<FileShare>();
    var sharedByMe = ViewBag.SharedByMe as List<FileShare> ?? new List<FileShare>();
}

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h2>Shared Files & Folders</h2>
            <p class="text-muted-foreground">View and manage shared content</p>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" id="sharesTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="shared-with-me-tab" data-bs-toggle="tab" data-bs-target="#shared-with-me" type="button" role="tab">
                Shared with Me (@sharedWithMe.Count)
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="shared-by-me-tab" data-bs-toggle="tab" data-bs-target="#shared-by-me" type="button" role="tab">
                Shared by Me (@sharedByMe.Count)
            </button>
        </li>
    </ul>

    <div class="tab-content" id="sharesTabContent">
        <!-- Shared with Me Tab -->
        <div class="tab-pane fade show active" id="shared-with-me" role="tabpanel">
            @if (sharedWithMe.Any())
            {
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Owner</th>
                                        <th>Permission</th>
                                        <th>Shared Date</th>
                                        <th style="width: 150px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var share in sharedWithMe)
                                    {
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    @if (share.FileEntry?.IsFolder == true)
                                                    {
                                                        <span class="me-2 fs-4">üìÅ</span>
                                                        <strong>@share.FileEntry.FileName</strong>
                                                    }
                                                    else
                                                    {
                                                        <span class="me-2">üìÑ</span>
                                                        <strong>@share.FileEntry?.FileName</strong>
                                                    }
                                                </div>
                                            </td>
                                            <td>
                                                @if (share.FileEntry?.IsFolder == true)
                                                {
                                                    <span class="badge bg-warning">Folder</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">File</span>
                                                }
                                            </td>
                                            <td>
                                                @if (share.Owner != null)
                                                {
                                                    <span>@(!string.IsNullOrEmpty(share.Owner.FirstName) ? $"{share.Owner.FirstName} {share.Owner.LastName}" : share.Owner.Email)</span>
                                                }
                                            </td>
                                            <td>
                                                @switch (share.Permission)
                                                {
                                                    case SharePermission.ViewOnly:
                                                        <span class="badge bg-info">View Only</span>
                                                        break;
                                                    case SharePermission.ViewAndUpload:
                                                        <span class="badge bg-primary">View & Upload</span>
                                                        break;
                                                    case SharePermission.Edit:
                                                        <span class="badge bg-success">Full Edit</span>
                                                        break;
                                                }
                                            </td>
                                            <td>@share.SharedDate.ToLocalTime().ToString("MMM dd, yyyy")</td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    @if (share.FileEntry?.IsFolder == true)
                                                    {
                                                        <a href="@Url.Action("Browse", "Shares", new { shareId = share.Id })" class="btn btn-outline-primary" title="Browse">
                                                            @Html.Raw(Icons.Get("folder", 16))
                                                        </a>
                                                    }
                                                    else
                                                    {
                                                        <a href="@Url.Action("Download", "Files", new { id = share.FileEntry?.Id })" class="btn btn-outline-primary" title="Download">
                                                            @Html.Raw(Icons.Get("download", 16))
                                                        </a>
                                                    }
                                                    <form asp-action="Unshare" asp-route-shareId="@share.Id" asp-route-returnUrl="Shares" method="post" style="display: inline;" onsubmit="return confirm('Remove access to this shared item?');">
                                                        @Html.AntiForgeryToken()
                                                        <button type="submit" class="btn btn-outline-danger" title="Remove Access">
                                                            @Html.Raw(Icons.Get("x", 16))
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card">
                    <div class="card-body text-center py-5">
                        @Html.Raw(Icons.Get("lock", 64, "text-muted mb-3"))
                        <h4>No Shared Items</h4>
                        <p class="text-muted-foreground">No one has shared any files or folders with you yet.</p>
                    </div>
                </div>
            }
        </div>

        <!-- Shared by Me Tab -->
        <div class="tab-pane fade" id="shared-by-me" role="tabpanel">
            @if (sharedByMe.Any())
            {
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Type</th>
                                        <th>Shared With</th>
                                        <th>Permission</th>
                                        <th>Shared Date</th>
                                        <th style="width: 100px;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var share in sharedByMe)
                                    {
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    @if (share.FileEntry?.IsFolder == true)
                                                    {
                                                        <span class="me-2 fs-4">üìÅ</span>
                                                        <strong>@share.FileEntry.FileName</strong>
                                                    }
                                                    else
                                                    {
                                                        <span class="me-2">üìÑ</span>
                                                        <strong>@share.FileEntry?.FileName</strong>
                                                    }
                                                </div>
                                            </td>
                                            <td>
                                                @if (share.FileEntry?.IsFolder == true)
                                                {
                                                    <span class="badge bg-warning">Folder</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary">File</span>
                                                }
                                            </td>
                                            <td>
                                                @if (share.SharedWithUser != null)
                                                {
                                                    <span>@(!string.IsNullOrEmpty(share.SharedWithUser.FirstName) ? $"{share.SharedWithUser.FirstName} {share.SharedWithUser.LastName}" : share.SharedWithUser.Email)</span>
                                                }
                                            </td>
                                            <td>
                                                @switch (share.Permission)
                                                {
                                                    case SharePermission.ViewOnly:
                                                        <span class="badge bg-info">View Only</span>
                                                        break;
                                                    case SharePermission.ViewAndUpload:
                                                        <span class="badge bg-primary">View & Upload</span>
                                                        break;
                                                    case SharePermission.Edit:
                                                        <span class="badge bg-success">Full Edit</span>
                                                        break;
                                                }
                                            </td>
                                            <td>@share.SharedDate.ToLocalTime().ToString("MMM dd, yyyy")</td>
                                            <td>
                                                <form asp-action="Unshare" asp-route-shareId="@share.Id" asp-route-returnUrl="Shares" method="post" style="display: inline;" onsubmit="return confirm('Stop sharing this item?');">
                                                    @Html.AntiForgeryToken()
                                                    <button type="submit" class="btn btn-outline-danger btn-sm" title="Stop Sharing">
                                                        @Html.Raw(Icons.Get("x", 16))
                                                    </button>
                                                </form>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card">
                    <div class="card-body text-center py-5">
                        @Html.Raw(Icons.Get("lock", 64, "text-muted mb-3"))
                        <h4>No Shared Items</h4>
                        <p class="text-muted-foreground">You haven't shared any files or folders yet.</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .card {
        background: var(--card);
        border-color: var(--border);
    }

    .card-header {
        background: var(--muted);
        color: var(--foreground);
        border-bottom: 1px solid var(--border);
    }

    .card-body {
        background: var(--card);
    }

    .table {
        color: var(--foreground) !important;
        background: transparent;
        --bs-table-color: var(--foreground);
        --bs-table-bg: transparent;
        --bs-table-border-color: var(--border);
    }

    .table th {
        background: var(--muted) !important;
        color: var(--foreground) !important;
        font-weight: 600;
        border-bottom: 2px solid var(--border);
    }

    .table td {
        background: var(--card) !important;
        color: var(--foreground) !important;
        border-color: var(--border) !important;
    }

    .table tbody tr {
        background: var(--card) !important;
        color: var(--foreground) !important;
    }

    .table tbody tr:hover {
        background: var(--accent) !important;
    }

    .table tbody tr:hover td {
        background: var(--accent) !important;
        color: var(--foreground) !important;
    }

    .table td a,
    .table td strong {
        color: var(--foreground) !important;
    }

    .table td a:hover {
        color: var(--primary) !important;
    }

    .nav-tabs .nav-link {
        color: var(--foreground);
        background: transparent;
        border-color: transparent;
    }

    .nav-tabs .nav-link:hover {
        background: var(--muted);
        border-color: var(--border);
    }

    .nav-tabs .nav-link.active {
        color: var(--primary);
        background: var(--card);
        border-color: var(--border) var(--border) var(--card);
    }
</style>
